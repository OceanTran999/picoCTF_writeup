![chal](https://github.com/user-attachments/assets/6c8fff54-4e66-4191-8cf0-b666d3a5d4f4)


This challenge only has the `NX` protection which doesn't allow us to execute shellcode in the stack.

![code](https://github.com/user-attachments/assets/416cf9b0-c820-459a-b390-6e2f5846c0bd)


As same as the previous challenge, we see that there's a format string vulnerability in line 92, but in this time, the flag is not saved in the stack, so we have to get the shell from the target server. So how can we do this? The program's protection has `Partial RELRO`, which allows us to overwrite the `GOT` address of functions, right? But, the input is saved in the heap, not in stack than I expect, what should we do? The answer is that we have to find the pointer in the stack, then make it point to the GOT address of an abitrary function. After that, we have to know the position that the pointer is pointing to in the stack so that we can overwrite the GOT address with a function such as `system` to get the shellcode. The target pointer I use will be the `$rbp` of the `buy_stonk()` because it has the value of saved $rbp register which is in the `main()` function.

![run](https://github.com/user-attachments/assets/edc3e4a1-320b-4c4d-bed4-2a30aab4851f)


![gdb1](https://github.com/user-attachments/assets/c3ab74df-5c69-417d-a56c-fb77e988a978)


We can see that the `$rbp` of `buy_stonk()` is at `12th` position, and the `$rbp` of `main()` is at `20th` position. So we will overwrite the $rbp of `buy_stonk()` with the GOT address of `free()`, now the $rbp register of `main()` function now pointing to `free@got.plt`. At first I tried with the input `%6299672x%12$n` but provide give the `segmentation fault`, maybe because I overwrite directly the value of $rbp register. :(

![gdb2](https://github.com/user-attachments/assets/829191b0-2cc5-44d6-8555-468a3c8155cb)


Looking at the address GOT of `free()`, we see that the value is `0x4006c6` which is the address of `system@plt`, thanks to that the program provide us the `system()` so we will overwrite this value to make the `free@got.plt` points to the `system@plt`. At first I directly use `0xf0` to point to `system()`, but then I realize that I have to give a value so that the value `c6` will add the given value to give the total value `0x4006f0`, which is the value of `system@plt`.

![free_got](https://github.com/user-attachments/assets/802cf54b-8a6b-4350-81e1-afa7e42ee216)


![gdb3](https://github.com/user-attachments/assets/da757890-6f97-4083-b5d4-bd3295156750)


Now finally, we just need to give the `sh\x00\x01` to get the shell. In the `main()`, we have a `free(<Portfolio *>p)` right? And it is in the `18th` position in the stack, so we just overwrite it with `16,803,955` (0x1006873) and get the shell.
But..., the shell doesn't appear, it takes me more than 30 minutes to try to understand, and I find that the value I give is not correct...

![shell_failed](https://github.com/user-attachments/assets/628467f8-edda-4a5a-9a99-18b37b888455)


So, minus it with `0x1006873` I will get the value is `0x6020f0`, minus this value 1 more time and I will get the exactly value I want.

![Success](https://github.com/user-attachments/assets/c89c4272-9653-4c48-9321-0537c9b071bb)


![Flag](https://github.com/user-attachments/assets/b5d1873d-e58d-422e-a1b1-0f86205a822b)
